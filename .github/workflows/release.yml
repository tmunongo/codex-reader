name: Release

on:
    push:
        tags:
            - "v*"

jobs:
    build-windows:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v3

            - uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Install dependencies
              run: flutter pub get

            - name: Build Windows
              run: flutter build windows --release

            - name: Create ZIP
              run: |
                  cd build/windows/x64/runner/Release
                  7z a ../../../../../codex-windows-x64.zip *

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: windows-build
                  path: codex-windows-x64.zip

    build-linux:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

            - uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Install dependencies
              run: flutter pub get

            - name: Build Linux
              run: flutter build linux --release

            - name: Create tarball
              run: |
                  cd build/linux/x64/release/bundle
                  tar -czvf ../../../../../codex-linux-x64.tar.gz *

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-build
                  path: codex-linux-x64.tar.gz

    release:
        needs: [build-windows, build-linux]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Download Windows build
              uses: actions/download-artifact@v3
              with:
                  name: windows-build

            - name: Download Linux build
              uses: actions/download-artifact@v3
              with:
                  name: linux-build

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      codex-windows-x64.zip
                      codex-linux-x64.tar.gz
                  body: |
                      ## Codex ${{ github.ref_name }}

                      **Read the source.**

                      A calm, customizable Markdown reader for researchers and writers.

                      ### Downloads
                      - **Windows**: `codex-windows-x64.zip` - Extract and run `codex.exe`
                      - **Linux**: `codex-linux-x64.tar.gz` - Extract and run `codex`

                      ### What's New
                      - Initial release
                      - Single file and project mode
                      - Custom theme support
                      - Syntax highlighting
                      - File tree navigation

                      See [README.md](https://github.com/tmunongo/codex-reader#readme) for installation instructions.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
